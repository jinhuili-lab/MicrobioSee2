<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title>R: Nonlinear Least Squares Fit for LM-OSL curves</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
<link rel="stylesheet" type="text/css" href="R.css" />
</head><body><div class="container">

<table width="100%" summary="page for fit_LMCurve {Luminescence}"><tr><td>fit_LMCurve {Luminescence}</td><td style="text-align: right;">R Documentation</td></tr></table>

<h2>Nonlinear Least Squares Fit for LM-OSL curves</h2>

<h3>Description</h3>

<p>The function determines weighted nonlinear least-squares estimates of the
component parameters of an LM-OSL curve (Bulur 1996) for a given number of
components and returns various component parameters. The fitting procedure
uses the function <a href="../../stats/html/nls.html">nls</a> with the <code>port</code> algorithm.
</p>


<h3>Usage</h3>

<pre>
fit_LMCurve(
  values,
  values.bg,
  n.components = 3,
  start_values,
  input.dataType = "LM",
  fit.method = "port",
  sample_code = "",
  sample_ID = "",
  LED.power = 36,
  LED.wavelength = 470,
  fit.trace = FALSE,
  fit.advanced = FALSE,
  fit.calcError = FALSE,
  bg.subtraction = "polynomial",
  verbose = TRUE,
  plot = TRUE,
  plot.BG = FALSE,
  ...
)
</pre>


<h3>Arguments</h3>

<table summary="R argblock">
<tr valign="top"><td><code>values</code></td>
<td>
<p><a href="../../Luminescence/help/RLum.Data.Curve-class.html">RLum.Data.Curve</a> or <a href="../../base/html/data.frame.html">data.frame</a> (<strong>required</strong>):
x,y data of measured values (time and counts). See examples.</p>
</td></tr>
<tr valign="top"><td><code>values.bg</code></td>
<td>
<p><a href="../../Luminescence/help/RLum.Data.Curve-class.html">RLum.Data.Curve</a> or <a href="../../base/html/data.frame.html">data.frame</a> (<em>optional</em>):
x,y data of measured values (time and counts) for background subtraction.</p>
</td></tr>
<tr valign="top"><td><code>n.components</code></td>
<td>
<p><a href="../../base/html/integer.html">integer</a> (<em>with default</em>):
fixed number of components that are to be recognised during fitting
(min = 1, max = 7).</p>
</td></tr>
<tr valign="top"><td><code>start_values</code></td>
<td>
<p><a href="../../base/html/data.frame.html">data.frame</a> (<em>optional</em>):
start parameters for <code>lm</code> and <code>xm</code> data for the fit. If no start values are given,
an automatic start value estimation is attempted (see details).</p>
</td></tr>
<tr valign="top"><td><code>input.dataType</code></td>
<td>
<p><a href="../../base/html/character.html">character</a> (<em>with default</em>):
alter the plot output depending on the input data: <code>"LM"</code> or <code>"pLM"</code> (pseudo-LM).
See: <a href="../../Luminescence/help/CW2pLM.html">CW2pLM</a></p>
</td></tr>
<tr valign="top"><td><code>fit.method</code></td>
<td>
<p><a href="../../base/html/character.html">character</a> (<em>with default</em>):
select fit method, allowed values: <code>'port'</code> and <code>'LM'</code>. <code>'port'</code> uses the 'port'
routine from the function <a href="../../stats/html/nls.html">nls</a> <code>'LM'</code> utilises the function <code>nlsLM</code> from
the package <code>minpack.lm</code> and with that the Levenberg-Marquardt algorithm.</p>
</td></tr>
<tr valign="top"><td><code>sample_code</code></td>
<td>
<p><a href="../../base/html/character.html">character</a> (<em>optional</em>):
sample code used for the plot and the optional output table (mtext).</p>
</td></tr>
<tr valign="top"><td><code>sample_ID</code></td>
<td>
<p><a href="../../base/html/character.html">character</a> (<em>optional</em>):
additional identifier used as column header for the table output.</p>
</td></tr>
<tr valign="top"><td><code>LED.power</code></td>
<td>
<p><a href="../../base/html/numeric.html">numeric</a> (<em>with default</em>):
LED power (max.) used for intensity ramping in mW/cm^2.
<strong>Note:</strong> This value is used for the calculation of the absolute
photoionisation cross section.</p>
</td></tr>
<tr valign="top"><td><code>LED.wavelength</code></td>
<td>
<p><a href="../../base/html/numeric.html">numeric</a> (<em>with default</em>):
LED wavelength in nm used for stimulation.
<strong>Note:</strong> This value is used for the calculation of the absolute
photoionisation cross section.</p>
</td></tr>
<tr valign="top"><td><code>fit.trace</code></td>
<td>
<p><a href="../../base/html/logical.html">logical</a> (<em>with default</em>):
traces the fitting process on the terminal.</p>
</td></tr>
<tr valign="top"><td><code>fit.advanced</code></td>
<td>
<p><a href="../../base/html/logical.html">logical</a> (<em>with default</em>):
enables advanced fitting attempt for automatic start parameter recognition.
Works only if no start parameters are provided.
<strong>Note:</strong> It may take a while and it is not compatible with <code>fit.method = "LM"</code>.</p>
</td></tr>
<tr valign="top"><td><code>fit.calcError</code></td>
<td>
<p><a href="../../base/html/logical.html">logical</a> (<em>with default</em>):
calculate 1-sigma error range of components using <a href="../../stats/help/confint.html">stats::confint</a>.</p>
</td></tr>
<tr valign="top"><td><code>bg.subtraction</code></td>
<td>
<p><a href="../../base/html/character.html">character</a> (<em>with default</em>):
specifies method for background subtraction (<code>polynomial</code>, <code>linear</code>, <code>channel</code>,
see Details). <strong>Note:</strong> requires input for <code>values.bg</code>.</p>
</td></tr>
<tr valign="top"><td><code>verbose</code></td>
<td>
<p><a href="../../base/html/logical.html">logical</a> (<em>with default</em>):
terminal output with fitting results.</p>
</td></tr>
<tr valign="top"><td><code>plot</code></td>
<td>
<p><a href="../../base/html/logical.html">logical</a> (<em>with default</em>):
returns a plot of the fitted curves.</p>
</td></tr>
<tr valign="top"><td><code>plot.BG</code></td>
<td>
<p><a href="../../base/html/logical.html">logical</a> (<em>with default</em>):
returns a plot of the background values with the fit used for the
background subtraction.</p>
</td></tr>
<tr valign="top"><td><code>...</code></td>
<td>
<p>Further arguments that may be passed to the plot output, e.g.
<code>xlab</code>, <code>xlab</code>, <code>main</code>, <code>log</code>.</p>
</td></tr>
</table>


<h3>Details</h3>

<p><strong>Fitting function</strong>
</p>
<p>The function for the fitting has the general
form:
</p>
<p style="text-align: center;"><i>y = (exp(0.5)*Im_1*x/xm_1)*exp(-x^2/(2*xm_1^2)) + ,&hellip;, + exp(0.5)*Im_i*x/xm_i)*exp(-x^2/(2*xm_i^2))</i></p>

<p>where <i>1 &lt; i &lt; 8</i>
</p>
<p>This function and the equations for the conversion to b (detrapping probability)
and n0 (proportional to initially trapped charge) have been taken from Kitis
et al. (2008):
</p>
<p style="text-align: center;"><i>xm_i=&radic;{max(t)/b_i}</i></p>

<p style="text-align: center;"><i>Im_i=exp(-0.5)n0/xm_i</i></p>

<p><strong>Background subtraction</strong>
</p>
<p>Three methods for background subtraction
are provided for a given background signal (<code>values.bg</code>).
</p>

<ul>
<li> <p><code>polynomial</code>: default method. A polynomial function is fitted using <a href="../../stats/html/glm.html">glm</a>
and the resulting function is used for background subtraction:
</p>
<p style="text-align: center;"><i>y = a*x^4 + b*x^3 + c*x^2 + d*x + e</i></p>

</li>
<li> <p><code>linear</code>: a linear function is fitted using <a href="../../stats/html/glm.html">glm</a> and the resulting function
is used for background subtraction:
</p>
<p style="text-align: center;"><i>y = a*x + b</i></p>

</li>
<li> <p><code>channel</code>: the measured
background signal is subtracted channel wise from the measured signal.
</p>
</li></ul>

<p><strong>Start values</strong>
</p>
<p>The choice of the initial parameters for the <code>nls</code>-fitting is a crucial
point and the fitting procedure may mainly fail due to ill chosen start
parameters. Here, three options are provided:
</p>
<p><strong>(a)</strong>
If no start values (<code>start_values</code>) are provided by the user, a cheap guess is made
by using the detrapping values found by Jain et al. (2003) for quartz for a
maximum of 7 components. Based on these values, the pseudo start parameters
<code>xm</code> and <code>Im</code> are recalculated for the given data set. In all cases, the fitting
starts with the ultra-fast component and (depending on <code>n.components</code>)
steps through the following values. If no fit could be achieved, an error
plot (for <code>plot = TRUE</code>) with the pseudo curve (based on the
pseudo start parameters) is provided. This may give the opportunity to
identify appropriate start parameters visually.
</p>
<p><strong>(b)</strong>
If start values are provided, the function works like a simple <a href="../../stats/html/nls.html">nls</a>
fitting approach.
</p>
<p><strong>(c)</strong>
If no start parameters are provided and
the option <code>fit.advanced = TRUE</code> is chosen, an advanced start parameter
estimation is applied using a stochastic attempt. Therefore, the
recalculated start parameters <strong>(a)</strong> are used to construct a normal
distribution. The start parameters are then sampled randomly from this
distribution. A maximum of 100 attempts will be made. <strong>Note:</strong> This
process may be time consuming.
</p>
<p><strong>Goodness of fit</strong>
</p>
<p>The goodness of the fit is given by a pseudo-R^2 value (pseudo coefficient of
determination). According to Lave (1970), the value is calculated as:
</p>
<p style="text-align: center;"><i>pseudoR^2 = 1 - RSS/TSS</i></p>

<p>where <i>RSS = Residual~Sum~of~Squares</i>
and <i>TSS = Total~Sum~of~Squares</i>
</p>
<p><strong>Error of fitted component parameters</strong>
</p>
<p>The 1-sigma error for the components is calculated using
the function <a href="../../stats/help/confint.html">stats::confint</a>. Due to considerable calculation time, this
option is deactivated by default. In addition, the error for the components
can be estimated by using internal R functions like <a href="../../base/html/summary.html">summary</a>. See the
<a href="../../stats/html/nls.html">nls</a> help page for more information.
</p>
<p><em>For more details on the nonlinear regression in R, see Ritz &amp; Streibig (2008).</em>
</p>


<h3>Value</h3>

<p>Various types of plots are returned. For details see above. Furthermore an
<code>RLum.Results</code> object is returned with the following structure:
</p>
<p><strong><code style="white-space: pre;">@data:</code></strong>
</p>
<p><code>.. $data</code> : <a href="../../base/html/data.frame.html">data.frame</a> with fitting results<br />
<code>.. $fit</code> : nls (<a href="../../stats/html/nls.html">nls</a> object)<br />
<code>.. $component_matrix</code> : <a href="../../base/html/matrix.html">matrix</a> with numerical xy-values of the single fitted components with the resolution of the input data
<code>.. $component.contribution.matrix</code> : <a href="../../base/html/list.html">list</a> component distribution matrix
</p>
<p><strong><code style="white-space: pre;">info:</code></strong>
</p>
<p><code>.. $call</code> : <a href="../../base/html/call.html">call</a> the original function call
</p>
<p>Matrix structure for the distribution matrix:
</p>
<p>Column 1 and 2: time and <code>rev(time)</code> values<br />
Additional columns are used for the components, two for each component,
containing I0 and n0. The last columns <code>cont.</code> provide information on
the relative component contribution for each time interval including the row
sum for this values.
</p>


<h3>Function version</h3>

<p>0.3.3
</p>


<h3>How to cite</h3>

<p>Kreutzer, S., 2021. fit_LMCurve(): Nonlinear Least Squares Fit for LM-OSL curves. Function version 0.3.3. In: Kreutzer, S., Burow, C., Dietze, M., Fuchs, M.C., Schmidt, C., Fischer, M., Friedrich, J., Mercier, N., Philippe, A., Riedesel, S., Autzen, M., Mittelstrass, D., Gray, H.J., 2021. Luminescence: Comprehensive Luminescence Dating Data Analysis. R package version 0.9.15. https://CRAN.R-project.org/package=Luminescence
</p>


<h3>Note</h3>

<p>The pseudo-R^2 may not be the best parameter to describe the goodness
of the fit. The trade off between the <code>n.components</code> and the pseudo-R^2
value currently remains unconsidered.
</p>
<p>The function <strong>does not</strong> ensure that the fitting procedure has reached a
global minimum rather than a local minimum! In any case of doubt, the use of
manual start values is highly recommended.
</p>


<h3>Author(s)</h3>

<p>Sebastian Kreutzer, Geography &amp; Earth Sciences, Aberystwyth University (United Kingdom)
, RLum Developer Team</p>


<h3>References</h3>

<p>Bulur, E., 1996. An Alternative Technique For Optically
Stimulated Luminescence (OSL) Experiment. Radiation Measurements, 26, 5,
701-709.
</p>
<p>Jain, M., Murray, A.S., Boetter-Jensen, L., 2003. Characterisation of
blue-light stimulated luminescence components in different quartz samples:
implications for dose measurement. Radiation Measurements, 37 (4-5),
441-449.
</p>
<p>Kitis, G. &amp; Pagonis, V., 2008. Computerized curve deconvolution analysis for
LM-OSL. Radiation Measurements, 43, 737-741.
</p>
<p>Lave, C.A.T., 1970. The Demand for Urban Mass Transportation. The Review of
Economics and Statistics, 52 (3), 320-323.
</p>
<p>Ritz, C. &amp; Streibig, J.C., 2008. Nonlinear Regression with R. R. Gentleman,
K. Hornik, &amp; G. Parmigiani, eds., Springer, p. 150.
</p>


<h3>See Also</h3>

<p><a href="../../Luminescence/help/fit_CWCurve.html">fit_CWCurve</a>, <a href="../../graphics/html/plot.default.html">plot</a>, <a href="../../stats/html/nls.html">nls</a>, <a href="../../minpack.lm/help/nlsLM.html">minpack.lm::nlsLM</a>, <a href="../../Luminescence/help/get_RLum.html">get_RLum</a>
</p>


<h3>Examples</h3>

<pre>

##(1) fit LM data without background subtraction
data(ExampleData.FittingLM, envir = environment())
fit_LMCurve(values = values.curve, n.components = 3, log = "x")

##(2) fit LM data with background subtraction and export as JPEG
## -alter file path for your preferred system
##jpeg(file = "~/Desktop/Fit_Output\%03d.jpg", quality = 100,
## height = 3000, width = 3000, res = 300)
data(ExampleData.FittingLM, envir = environment())
fit_LMCurve(values = values.curve, values.bg = values.curveBG,
            n.components = 2, log = "x", plot.BG = TRUE)
##dev.off()

##(3) fit LM data with manual start parameters
data(ExampleData.FittingLM, envir = environment())
fit_LMCurve(values = values.curve,
            values.bg = values.curveBG,
            n.components = 3,
            log = "x",
            start_values = data.frame(Im = c(170,25,400), xm = c(56,200,1500)))

</pre>

<hr /><div style="text-align: center;">[Package <em>Luminescence</em> version 0.9.15 <a href="00Index.html">Index</a>]</div>
</div></body></html>
